<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Role Assignment</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.2/dist/web3.min.js"></script>
</head>
<body>
<center>
<h1>Role Assignment</h1>

<button id="loginButton" onclick="login()">Login with MetaMask</button>
<hr>
<button onclick="register()">Register</button>

<script>
    let web3;
    let contract;
    
    const contractABI = [
        {
            "inputs": [
                {
                    "internalType": "address",
                    "name": "_user",
                    "type": "address"
                },
                {
                    "internalType": "string",
                    "name": "_role",
                    "type": "string"
                }
            ],
            "name": "assignRole",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [
                {
                    "internalType": "address",
                    "name": "_user",
                    "type": "address"
                }
            ],
            "name": "checkRole",
            "outputs": [
                {
                    "internalType": "string",
                    "name": "",
                    "type": "string"
                }
            ],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [],
            "name": "ownerInfo",
            "outputs": [
                {
                    "internalType": "address",
                    "name": "",
                    "type": "address"
                }
            ],
            "stateMutability": "view",
            "type": "function"
        }
    ];
    const contractAddress = '0xB527436d6F64Bd8f2Ed9BeF0B422a82c2adFc283'; // Replace with your contract address

    async function init() {
        // Connect to MetaMask
        if (window.ethereum) {
            web3 = new Web3(window.ethereum);
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const userAddress = accounts[0];
                console.log("Connected account:", userAddress);

                // Set button text dynamically
                document.getElementById("loginButton").innerText = `Login with ${userAddress}`;
            } catch (error) {
                console.error("User denied account access");
            }
        } else {
            console.error("MetaMask not detected!");
        }

        // Load contract
        contract = new web3.eth.Contract(contractABI, contractAddress);
    }

    async function login() {
        const accounts = await web3.eth.getAccounts();
        const userAddress = accounts[0];
        
        // Call the checkRole function
        const role = await contract.methods.checkRole(userAddress).call();

        // Redirect based on the role
        if (role === "Student") {
            window.location.href = "student.html";
        } else if (role === "Authority") {
            window.location.href = "authority.html";
        } else {
            alert("You don't have a valid role. Please register first");
        }
    }

    function register() {
        window.location.href = "register.html";
    }

    window.onload = init;
</script>
</center>
</body>
</html>
